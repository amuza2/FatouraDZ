<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:FatouraDZ.ViewModels"
             xmlns:models="using:FatouraDZ.Models"
             mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="900"
             x:Class="FatouraDZ.Views.NouvelleFactureView"
             x:DataType="vm:NouvelleFactureViewModel">

    <Design.DataContext>
        <vm:NouvelleFactureViewModel/>
    </Design.DataContext>

    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="20">
        <StackPanel Spacing="20" MaxWidth="1000" HorizontalAlignment="Center">
            
            <!-- Titre -->
            <TextBlock Text="{Binding TitreFormulaire}" 
                       FontSize="24" FontWeight="Bold" 
                       HorizontalAlignment="Center"
                       Margin="0,0,0,10"/>

            <!-- Message d'erreur -->
            <Border Background="#FFEBEE" BorderBrush="#EF4444" BorderThickness="1" 
                    CornerRadius="4" Padding="10"
                    IsVisible="{Binding ErreurMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                <TextBlock Text="{Binding ErreurMessage}" Foreground="#EF4444" TextWrapping="Wrap"/>
            </Border>

            <!-- Message de succÃ¨s -->
            <Border Background="#E8F5E9" BorderBrush="#10B981" BorderThickness="1" 
                    CornerRadius="4" Padding="10"
                    IsVisible="{Binding EstSauvegarde}">
                <TextBlock Text="âœ“ Facture sauvegardÃ©e avec succÃ¨s" Foreground="#10B981"/>
            </Border>

            <!-- Section: Type de facture et informations -->
            <Border Classes="card">
                <StackPanel Spacing="15">
                    <TextBlock Text="Informations de la facture" FontSize="16" FontWeight="SemiBold" Foreground="#2563EB"/>
                    
                    <Grid ColumnDefinitions="*,20,*,20,*">
                        <!-- Type de facture -->
                        <StackPanel Grid.Column="0" Spacing="4">
                            <TextBlock Text="Type de facture" FontWeight="Medium"/>
                            <ComboBox SelectedIndex="{Binding TypeFactureIndex}" HorizontalAlignment="Stretch">
                                <ComboBoxItem Content="Facture normale"/>
                                <ComboBoxItem Content="Facture d'avoir"/>
                                <ComboBoxItem Content="Facture d'annulation"/>
                            </ComboBox>
                        </StackPanel>
                        
                        <!-- NumÃ©ro de facture -->
                        <StackPanel Grid.Column="2" Spacing="4">
                            <TextBlock Text="NumÃ©ro de facture" FontWeight="Medium"/>
                            <TextBox Text="{Binding NumeroFacture}" IsReadOnly="True" 
                                     Background="#F1F5F9"/>
                        </StackPanel>
                        
                        <!-- Mode de paiement -->
                        <StackPanel Grid.Column="4" Spacing="4">
                            <TextBlock Text="Mode de paiement" FontWeight="Medium"/>
                            <ComboBox ItemsSource="{Binding ModesPaiement}" 
                                      SelectedItem="{Binding ModePaiement}"
                                      HorizontalAlignment="Stretch"/>
                        </StackPanel>
                    </Grid>

                    <Grid ColumnDefinitions="*,20,*">
                        <!-- Date de facture -->
                        <StackPanel Grid.Column="0" Spacing="4">
                            <TextBlock Text="Date de facture" FontWeight="Medium"/>
                            <DatePicker SelectedDate="{Binding DateFacture}" 
                                        HorizontalAlignment="Stretch"/>
                        </StackPanel>
                        
                        <!-- Date d'Ã©chÃ©ance -->
                        <StackPanel Grid.Column="2" Spacing="4">
                            <TextBlock Text="Date d'Ã©chÃ©ance" FontWeight="Medium"/>
                            <DatePicker SelectedDate="{Binding DateEcheance}"
                                        HorizontalAlignment="Stretch"/>
                            <TextBlock Text="{Binding ErreurDateEcheance}" Classes="error-message"
                                       IsVisible="{Binding ErreurDateEcheance, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                        </StackPanel>
                    </Grid>

                    <!-- DÃ©tails du paiement (visible selon le mode) -->
                    <Border Background="#FEF3C7" CornerRadius="4" Padding="15" 
                            IsVisible="{Binding RequiertDetailsPaiement}">
                        <StackPanel Spacing="10">
                            <TextBlock Text="ðŸ’³ DÃ©tails du paiement" FontWeight="SemiBold" Foreground="#92400E"/>
                            <StackPanel Spacing="4">
                                <TextBlock Text="NumÃ©ro de rÃ©fÃ©rence (chÃ¨que, virement, etc.)" FontWeight="Medium"/>
                                <TextBox Text="{Binding PaiementReference}" 
                                         Watermark="NÂ° chÃ¨que, NÂ° virement, NÂ° transaction..."/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Border>

            <!-- Section: Informations client -->
            <Border Classes="card">
                <StackPanel Spacing="15">
                    <TextBlock Text="Informations du client" FontSize="16" FontWeight="SemiBold" Foreground="#2563EB"/>
                    
                    <!-- Nom et TÃ©lÃ©phone -->
                    <Grid ColumnDefinitions="*,20,*">
                        <StackPanel Grid.Column="0" Spacing="4">
                            <TextBlock Text="Nom du client *" FontWeight="Medium"/>
                            <TextBox Text="{Binding ClientNom}" Watermark="Nom complet ou raison sociale"
                                     Classes.error="{Binding ErreurClientNom, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                            <TextBlock Text="{Binding ErreurClientNom}" Classes="error-message"
                                       IsVisible="{Binding ErreurClientNom, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                        </StackPanel>
                        <StackPanel Grid.Column="2" Spacing="4">
                            <TextBlock Text="TÃ©lÃ©phone *" FontWeight="Medium"/>
                            <TextBox Text="{Binding ClientTelephone}" Watermark="05XX XX XX XX"
                                     Classes.error="{Binding ErreurClientTelephone, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                            <TextBlock Text="{Binding ErreurClientTelephone}" Classes="error-message"
                                       IsVisible="{Binding ErreurClientTelephone, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                        </StackPanel>
                    </Grid>

                    <!-- Adresse -->
                    <StackPanel Spacing="4">
                        <TextBlock Text="Adresse *" FontWeight="Medium"/>
                        <TextBox Text="{Binding ClientAdresse}" Watermark="Adresse complÃ¨te"
                                 Classes.error="{Binding ErreurClientAdresse, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                        <TextBlock Text="{Binding ErreurClientAdresse}" Classes="error-message"
                                   IsVisible="{Binding ErreurClientAdresse, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                    </StackPanel>

                    <!-- Email -->
                    <StackPanel Spacing="4" MaxWidth="400" HorizontalAlignment="Left">
                        <TextBlock Text="Email (optionnel)" FontWeight="Medium"/>
                        <TextBox Text="{Binding ClientEmail}" Watermark="email@exemple.com"
                                 Classes.error="{Binding ErreurClientEmail, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                        <TextBlock Text="{Binding ErreurClientEmail}" Classes="error-message"
                                   IsVisible="{Binding ErreurClientEmail, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Section: Informations fiscales client -->
            <Border Classes="card">
                <StackPanel Spacing="15">
                    <TextBlock Text="Informations fiscales du client" FontSize="16" FontWeight="SemiBold" Foreground="#2563EB"/>
                    <TextBlock Text="Ces informations sont obligatoires pour la validitÃ© lÃ©gale de la facture" 
                               Foreground="#64748B" FontSize="12"/>
                    
                    <Grid ColumnDefinitions="*,20,*">
                        <StackPanel Grid.Column="0" Spacing="4">
                            <TextBlock Text="Registre du Commerce (RC) *" FontWeight="Medium"/>
                            <TextBox Text="{Binding ClientRc}" Watermark="NumÃ©ro RC"/>
                        </StackPanel>
                        <StackPanel Grid.Column="2" Spacing="4">
                            <TextBlock Text="NIS (15 chiffres) *" FontWeight="Medium"/>
                            <TextBox Text="{Binding ClientNis}" Watermark="000000000000000"/>
                        </StackPanel>
                    </Grid>
                    <Grid ColumnDefinitions="*,20,*">
                        <StackPanel Grid.Column="0" Spacing="4">
                            <TextBlock Text="Article d'Imposition (AI) *" FontWeight="Medium"/>
                            <TextBox Text="{Binding ClientAi}" Watermark="NumÃ©ro AI"/>
                        </StackPanel>
                        <StackPanel Grid.Column="2" Spacing="4">
                            <TextBlock Text="NÂ° Immatriculation *" FontWeight="Medium"/>
                            <TextBox Text="{Binding ClientNumeroImmatriculation}" Watermark="NumÃ©ro d'immatriculation"/>
                        </StackPanel>
                    </Grid>
                    <StackPanel Spacing="4">
                        <TextBlock Text="ActivitÃ© *" FontWeight="Medium"/>
                        <TextBox Text="{Binding ClientActivite}" Watermark="ActivitÃ© commerciale du client"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Section: Lignes de facture -->
            <Border Classes="card">
                <StackPanel Spacing="15">
                    <Grid ColumnDefinitions="*,Auto">
                        <StackPanel>
                            <TextBlock Text="Services / Produits" FontSize="16" FontWeight="SemiBold" Foreground="#2563EB"/>
                            <TextBlock Text="{Binding ErreurLignes}" Classes="error-message"
                                       IsVisible="{Binding ErreurLignes, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                        </StackPanel>
                        <Button Grid.Column="1" Content="âž• Ajouter une ligne" 
                                Command="{Binding AjouterLigneCommand}"
                                Padding="15,8"/>
                    </Grid>

                    <!-- En-tÃªte du tableau -->
                    <Grid ColumnDefinitions="40,*,120,140,120,120,40" Background="#F1F5F9" Margin="0,10,0,0">
                        <TextBlock Grid.Column="0" Text="#" FontWeight="SemiBold" Padding="8" HorizontalAlignment="Center"/>
                        <TextBlock Grid.Column="1" Text="DÃ©signation" FontWeight="SemiBold" Padding="8"/>
                        <TextBlock Grid.Column="2" Text="QuantitÃ©" FontWeight="SemiBold" Padding="8" HorizontalAlignment="Center"/>
                        <TextBlock Grid.Column="3" Text="Prix unitaire" FontWeight="SemiBold" Padding="8" HorizontalAlignment="Center"/>
                        <TextBlock Grid.Column="4" Text="TVA" FontWeight="SemiBold" Padding="8" HorizontalAlignment="Center"/>
                        <TextBlock Grid.Column="5" Text="Total HT" FontWeight="SemiBold" Padding="8" HorizontalAlignment="Right"/>
                        <TextBlock Grid.Column="6" Text="" Padding="8"/>
                    </Grid>

                    <!-- Lignes -->
                    <ItemsControl ItemsSource="{Binding Lignes}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="vm:LigneFactureViewModel">
                                <Grid ColumnDefinitions="40,*,120,140,120,120,40" Margin="0,5,0,0">
                                    <TextBlock Grid.Column="0" Text="{Binding NumeroLigne}" 
                                               VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    <TextBox Grid.Column="1" Text="{Binding Designation}" 
                                             Watermark="Description du service/produit" Margin="5,0"/>
                                    <NumericUpDown Grid.Column="2" Value="{Binding Quantite}" 
                                                   Minimum="0.01" Increment="1" FormatString="0.##" Margin="5,0"/>
                                    <NumericUpDown Grid.Column="3" Value="{Binding PrixUnitaire}" 
                                                   Minimum="0" Increment="100" FormatString="0.00" Margin="5,0"/>
                                    <ComboBox Grid.Column="4" SelectedIndex="{Binding TauxTVAIndex}" Margin="5,0"
                                              HorizontalAlignment="Stretch">
                                        <ComboBoxItem Content="19%"/>
                                        <ComboBoxItem Content="9%"/>
                                        <ComboBoxItem Content="ExonÃ©rÃ©"/>
                                    </ComboBox>
                                    <TextBlock Grid.Column="5" Text="{Binding TotalHT, StringFormat={}{0:N2} DA}" 
                                               VerticalAlignment="Center" HorizontalAlignment="Right" Margin="5,0"
                                               FontWeight="Medium"/>
                                    <Button Grid.Column="6" Content="ðŸ—‘ï¸" 
                                            Command="{Binding $parent[ItemsControl].((vm:NouvelleFactureViewModel)DataContext).SupprimerLigneCommand}"
                                            CommandParameter="{Binding}"
                                            Padding="5" Background="Transparent"/>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>

            <!-- Section: RÃ©capitulatif -->
            <Border Classes="card">
                <Grid ColumnDefinitions="*,350">
                    <!-- Espace rÃ©servÃ© -->
                    <StackPanel Grid.Column="0" Spacing="15">
                    </StackPanel>

                    <!-- Totaux -->
                    <Border Grid.Column="1" Background="#F8FAFC" CornerRadius="8" Padding="20">
                        <StackPanel Spacing="10">
                            <TextBlock Text="RÃ©capitulatif" FontSize="16" FontWeight="SemiBold" Foreground="#2563EB"/>
                            
                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto">
                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Total HT"/>
                                <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding TotalHT, StringFormat={}{0:N2} DA}" 
                                           FontWeight="Medium" HorizontalAlignment="Right"/>
                                
                                <TextBlock Grid.Row="1" Grid.Column="0" Text="TVA 19%" Margin="0,5,0,0"/>
                                <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding TotalTVA19, StringFormat={}{0:N2} DA}" 
                                           HorizontalAlignment="Right" Margin="0,5,0,0"/>
                                
                                <TextBlock Grid.Row="2" Grid.Column="0" Text="TVA 9%" Margin="0,5,0,0"/>
                                <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding TotalTVA9, StringFormat={}{0:N2} DA}" 
                                           HorizontalAlignment="Right" Margin="0,5,0,0"/>
                                
                                <TextBlock Grid.Row="3" Grid.Column="0" Text="Timbre fiscal" Margin="0,5,0,0"
                                           IsVisible="{Binding AppliquerTimbre}"/>
                                <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding TimbreFiscal, StringFormat={}{0:N2} DA}" 
                                           HorizontalAlignment="Right" Margin="0,5,0,0"
                                           IsVisible="{Binding AppliquerTimbre}"/>
                                
                                <Separator Grid.Row="4" Grid.ColumnSpan="2" Margin="0,10"/>
                                
                                <TextBlock Grid.Row="5" Grid.Column="0" Text="Total TTC" Margin="0,5,0,0"/>
                                <TextBlock Grid.Row="5" Grid.Column="1" Text="{Binding TotalTTC, StringFormat={}{0:N2} DA}" 
                                           FontWeight="Medium" HorizontalAlignment="Right" Margin="0,5,0,0"/>
                                
                                <TextBlock Grid.Row="6" Grid.Column="0" Text="MONTANT TOTAL" 
                                           FontWeight="Bold" FontSize="16"/>
                                <TextBlock Grid.Row="6" Grid.Column="1" Text="{Binding MontantTotal, StringFormat={}{0:N2} DA}" 
                                           FontWeight="Bold" FontSize="16" Foreground="#2563EB" HorizontalAlignment="Right"/>
                            </Grid>
                        </StackPanel>
                    </Border>
                </Grid>
            </Border>

            <!-- Montant en lettres -->
            <Border Classes="card">
                <StackPanel Spacing="10">
                    <TextBlock Text="Montant en lettres" FontSize="14" FontWeight="SemiBold" Foreground="#64748B"/>
                    <TextBlock Text="{Binding MontantEnLettres}" FontStyle="Italic" TextWrapping="Wrap"/>
                </StackPanel>
            </Border>

            <!-- Boutons d'action -->
            <StackPanel Orientation="Horizontal" Spacing="15" HorizontalAlignment="Center" Margin="0,20,0,60">
                <Button Content="ðŸ”„ RÃ©initialiser" 
                        Command="{Binding ReinitialiserCommand}"
                        Padding="20,12"/>
                <Button Content="ðŸ‘ï¸ PrÃ©visualiser" 
                        Command="{Binding PrevisualiserCommand}"
                        Padding="20,12"/>
                <Button Content="ðŸ’¾ Enregistrer la facture" 
                        Classes="primary"
                        Command="{Binding SauvegarderCommand}"
                        Padding="30,12"
                        FontSize="14"/>
            </StackPanel>

        </StackPanel>
    </ScrollViewer>
</UserControl>
