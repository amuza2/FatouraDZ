<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:FatouraDZ.ViewModels"
             xmlns:models="using:FatouraDZ.Models"
             x:Class="FatouraDZ.Views.BusinessDetailView"
             x:DataType="vm:BusinessDetailViewModel">
    
    <Grid RowDefinitions="Auto,Auto,*">
        <!-- Header with back button -->
        <Border Grid.Row="0" Background="#F8FAFC" Padding="30,20" BorderBrush="#E2E8F0" BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <Button Grid.Column="0" Content="â† Retour" 
                        Command="{Binding GoBackCommand}"
                        Background="Transparent"
                        Foreground="#64748B"
                        Padding="10,8"
                        Margin="0,0,20,0"/>
                
                <StackPanel Grid.Column="1">
                    <TextBlock Text="{Binding Business.Nom}" FontSize="24" FontWeight="Bold" Foreground="#1E293B"/>
                    <TextBlock Foreground="#64748B" FontSize="13">
                        <Run Text="{Binding Business.Ville, Mode=OneWay}"/><Run Text=", "/><Run Text="{Binding Business.Wilaya, Mode=OneWay}"/>
                        <Run Text=" â€¢ "/><Run Text="{Binding Business.Activite, Mode=OneWay}"/>
                    </TextBlock>
                </StackPanel>
                
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="10">
                    <!-- <Button Content="Modifier" 
                            Command="{Binding EditBusinessCommand}"
                            Padding="15,10"/> -->
                    <Button Content="+ Nouvelle facture" 
                            Classes="primary"
                            Command="{Binding CreateInvoiceCommand}"
                            Padding="20,10"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Statistics -->
        <Border Grid.Row="1" Background="White" Padding="30,15" BorderBrush="#E2E8F0" BorderThickness="0,0,0,1">
            <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*">
                <!-- Year selector -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="10" HorizontalAlignment="Center" Margin="0,0,0,12">
                    <TextBlock Text="AnnÃ©e :" VerticalAlignment="Center" Foreground="#64748B" FontWeight="SemiBold"/>
                    <ComboBox ItemsSource="{Binding AnneesDisponibles}" 
                              SelectedItem="{Binding AnneeSelectionnee}"
                              Width="120" HorizontalContentAlignment="Center"/>
                </StackPanel>
                
                <!-- Stats row -->
                <Grid Grid.Row="1" ColumnDefinitions="*,*,*,*">
                    <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                        <TextBlock Text="{Binding NombreFactures}" FontSize="24" FontWeight="Bold" Foreground="#3B82F6" HorizontalAlignment="Center"/>
                        <TextBlock Text="Factures" Foreground="#64748B" FontSize="12" HorizontalAlignment="Center"/>
                    </StackPanel>
                    <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                        <TextBlock Text="{Binding ChiffreAffaires, StringFormat={}{0:N2} DA}" FontSize="24" FontWeight="Bold" Foreground="#10B981" HorizontalAlignment="Center"/>
                        <TextBlock Text="Chiffre d'affaires" Foreground="#64748B" FontSize="12" HorizontalAlignment="Center"/>
                    </StackPanel>
                    <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                        <TextBlock Text="{Binding FacturesEnAttente}" FontSize="24" FontWeight="Bold" Foreground="#F59E0B" HorizontalAlignment="Center"/>
                        <TextBlock Text="En attente" Foreground="#64748B" FontSize="12" HorizontalAlignment="Center"/>
                    </StackPanel>
                    <StackPanel Grid.Column="3" HorizontalAlignment="Center">
                        <TextBlock Text="{Binding FacturesPayees}" FontSize="24" FontWeight="Bold" Foreground="#10B981" HorizontalAlignment="Center"/>
                        <TextBlock Text="PayÃ©es" Foreground="#64748B" FontSize="12" HorizontalAlignment="Center"/>
                    </StackPanel>
                </Grid>
            </Grid>
        </Border>

        <!-- Content -->
        <Grid Grid.Row="2" RowDefinitions="Auto,*">
            <!-- Filters -->
            <Border Grid.Row="0" Background="White" Padding="30,15" BorderBrush="#E2E8F0" BorderThickness="0,0,0,1">
                <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto">
                    <TextBox Grid.Column="0" Text="{Binding Recherche}" 
                             Watermark="ðŸ” Rechercher par numÃ©ro ou client..."
                             MaxWidth="400" HorizontalAlignment="Left"/>
                    <ComboBox Grid.Column="1" SelectedIndex="{Binding TypeFactureIndex}" Margin="15,0,0,0" Width="150">
                        <ComboBoxItem Content="Tous types"/>
                        <ComboBoxItem Content="Normale"/>
                        <ComboBoxItem Content="Avoir"/>
                        <ComboBoxItem Content="Proforma"/>
                    </ComboBox>
                    <ComboBox Grid.Column="2" SelectedIndex="{Binding StatutIndex}" Margin="10,0,0,0" Width="150">
                        <ComboBoxItem Content="Tous statuts"/>
                        <ComboBoxItem Content="En attente"/>
                        <ComboBoxItem Content="PayÃ©e"/>
                        <ComboBoxItem Content="AnnulÃ©e"/>
                    </ComboBox>
                    <ComboBox Grid.Column="3" SelectedIndex="{Binding ArchiveFilterIndex}" Margin="10,0,0,0" Width="150">
                        <ComboBoxItem Content="ðŸ“„ Actives"/>
                        <ComboBoxItem Content="ðŸ“¦ ArchivÃ©es"/>
                    </ComboBox>
                </Grid>
            </Border>

            <!-- Invoice list -->
            <ScrollViewer Grid.Row="1" Padding="30,20">
                <StackPanel Spacing="10">
                    <!-- Error message -->
                    <Border Background="#FEE2E2" CornerRadius="8" Padding="15"
                            IsVisible="{Binding MessageErreur, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                        <TextBlock Text="{Binding MessageErreur}" Foreground="#DC2626" TextWrapping="Wrap"/>
                    </Border>

                    <!-- Empty state -->
                    <Border Background="#F8FAFC" CornerRadius="12" Padding="40"
                            IsVisible="{Binding !Factures.Count}"
                            HorizontalAlignment="Center">
                        <StackPanel HorizontalAlignment="Center" Spacing="10">
                            <TextBlock Text="ðŸ“„" FontSize="40" HorizontalAlignment="Center"/>
                            <TextBlock Text="Aucune facture" FontSize="18" FontWeight="SemiBold" 
                                       Foreground="#64748B" HorizontalAlignment="Center"/>
                            <TextBlock Text="CrÃ©ez votre premiÃ¨re facture pour cette entreprise"
                                       Foreground="#94A3B8" HorizontalAlignment="Center"/>
                            <Button Content="CrÃ©er une facture" 
                                    Classes="primary"
                                    Command="{Binding CreateInvoiceCommand}"
                                    HorizontalAlignment="Center"
                                    Margin="0,10,0,0"
                                    Padding="20,10"/>
                        </StackPanel>
                    </Border>

                    <!-- Invoice items -->
                    <ItemsControl ItemsSource="{Binding Factures}" x:Name="FacturesItemsControl">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="models:Facture">
                                <Border Background="White" CornerRadius="8" Padding="15" Margin="0,0,0,8"
                                        BorderBrush="#E2E8F0" BorderThickness="1"
                                        Cursor="Hand"
                                        Tag="{Binding}"
                                        PointerPressed="OnInvoiceBorderPointerPressed">
                                    <Border.ContextMenu>
                                        <ContextMenu x:CompileBindings="False">
                                            <MenuItem Header="ðŸ‘ï¸ AperÃ§u" Click="OnPreviewInvoiceClick"/>
                                            <MenuItem Header="âœï¸ Modifier" Click="OnEditInvoiceClick"/>
                                            <Separator/>
                                            <MenuItem Header="ðŸ’° Marquer payÃ©e/non payÃ©e" Click="OnTogglePaymentClick"/>
                                            <Separator/>
                                            <MenuItem Header="ðŸ“¦ Archiver/Restaurer" Click="OnToggleArchiveClick"/>
                                        </ContextMenu>
                                    </Border.ContextMenu>
                                    <Grid ColumnDefinitions="*,Auto">
                                        <!-- Invoice info -->
                                        <StackPanel Grid.Column="0" Spacing="3">
                                            <StackPanel Orientation="Horizontal" Spacing="10">
                                                <TextBlock Text="{Binding NumeroFacture}" FontWeight="SemiBold" FontSize="14"/>
                                                <Border Background="#EFF6FF" CornerRadius="4" Padding="6,2">
                                                    <TextBlock Text="{Binding TypeFacture}" FontSize="11" Foreground="#3B82F6"/>
                                                </Border>
                                                <Border Background="#FEF3C7" CornerRadius="4" Padding="6,2">
                                                    <TextBlock Text="{Binding Statut}" FontSize="11" Foreground="#92400E"/>
                                                </Border>
                                            </StackPanel>
                                            <TextBlock Text="{Binding ClientNom}" Foreground="#64748B" FontSize="13"/>
                                            <TextBlock Foreground="#94A3B8" FontSize="12">
                                                <Run Text="{Binding DateFacture, StringFormat={}{0:dd/MM/yyyy}, Mode=OneWay}"/>
                                                <Run Text=" â€¢ "/>
                                                <Run Text="{Binding MontantTotal, StringFormat={}{0:N2} DA, Mode=OneWay}"/>
                                            </TextBlock>
                                        </StackPanel>
                                        
                                        <!-- Amount -->
                                        <TextBlock Grid.Column="1" Text="{Binding MontantTotal, StringFormat={}{0:N2} DA}" 
                                                   FontWeight="Bold" FontSize="16" Foreground="#1E293B"
                                                   VerticalAlignment="Center" Margin="20,0"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </ScrollViewer>
        </Grid>
        
        <!-- Confirmation Dialog Overlay -->
        <Border Grid.RowSpan="3" Background="#80000000" IsVisible="{Binding ShowConfirmDialog}">
            <Border Background="White" CornerRadius="12" Padding="30" 
                    MaxWidth="400" HorizontalAlignment="Center" VerticalAlignment="Center">
                <StackPanel Spacing="20">
                    <TextBlock Text="Confirmation" FontSize="20" FontWeight="Bold" Foreground="#1E293B"/>
                    <TextBlock Text="{Binding ConfirmDialogMessage}" TextWrapping="Wrap" Foreground="#64748B"/>
                    <StackPanel Orientation="Horizontal" Spacing="15" HorizontalAlignment="Right">
                        <Button Content="Annuler" 
                                Command="{Binding CancelArchiveCommand}"
                                Padding="20,10"
                                Background="#E2E8F0"/>
                        <Button Content="Confirmer" 
                                Command="{Binding ConfirmArchiveCommand}"
                                Padding="20,10"
                                Background="#2563EB"
                                Foreground="White"
                                FontWeight="SemiBold"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</UserControl>
