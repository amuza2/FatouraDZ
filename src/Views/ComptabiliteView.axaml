<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:FatouraDZ.ViewModels"
             xmlns:models="using:FatouraDZ.Models"
             xmlns:conv="using:FatouraDZ.Converters"
             x:Class="FatouraDZ.Views.ComptabiliteView"
             x:DataType="vm:ComptabiliteViewModel">
    
    <UserControl.Styles>
        <Style Selector="StackPanel.action-buttons">
            <Setter Property="IsVisible" Value="False"/>
        </Style>
        <Style Selector="Border.transaction-row:pointerover StackPanel.action-buttons">
            <Setter Property="IsVisible" Value="True"/>
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="Auto,Auto,Auto,*">
        <!-- Header -->
        <Border Grid.Row="0" Background="#F8FAFC" Padding="30,20" BorderBrush="#E2E8F0" BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <Button Grid.Column="0" Content="â† Retour" 
                        Command="{Binding GoBackCommand}"
                        Background="Transparent"
                        Foreground="#64748B"
                        Padding="10,8"
                        Margin="0,0,20,0"/>
                
                <TextBlock Grid.Column="1" Text="ComptabilitÃ©" FontSize="24" FontWeight="Bold" Foreground="#1E293B" VerticalAlignment="Center"/>
                
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="10">
                    <ToggleButton Content="ðŸ“¦ ArchivÃ©es" IsChecked="{Binding AfficherArchivees}"
                                  Padding="15,10"/>
                    <Button Content="+ CatÃ©gorie" 
                            Command="{Binding NouvelleCategorieCommand}"
                            Padding="15,10"
                            Background="#E2E8F0"/>
                    <Button Content="+ Transaction" 
                            Classes="primary"
                            Command="{Binding NouvelleTransactionCommand}"
                            Padding="20,10"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Date filters -->
        <Border Grid.Row="1" Background="White" Padding="30,15" BorderBrush="#E2E8F0" BorderThickness="0,0,0,1">
            <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Center">
                <!-- Quick period buttons -->
                <StackPanel Orientation="Horizontal" Spacing="5">
                    <Button Content="Ce mois" Padding="14,8"
                            Tag="0" Click="OnPeriodeClick"/>
                    <Button Content="Mois dernier" Padding="14,8"
                            Tag="1" Click="OnPeriodeClick"/>
                    <Button Content="Cette annÃ©e" Padding="14,8"
                            Tag="2" Click="OnPeriodeClick"/>
                </StackPanel>

                <Border Width="1" Background="#E2E8F0" Margin="5,0"/>
                
                <!-- Custom date range -->
                <TextBlock Text="Du" VerticalAlignment="Center" Foreground="#64748B"/>
                <DatePicker SelectedDate="{Binding DateDebut}" MinWidth="130"/>
                <TextBlock Text="Au" VerticalAlignment="Center" Foreground="#64748B"/>
                <DatePicker SelectedDate="{Binding DateFin}" MinWidth="130"/>
            </StackPanel>
        </Border>

        <!-- Statistics cards -->
        <Border Grid.Row="2" Background="White" Padding="30,15" BorderBrush="#E2E8F0" BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="*,*,*">
                <Border Grid.Column="0" Background="#F0FDF4" CornerRadius="10" Padding="20,15" Margin="0,0,10,0">
                    <StackPanel HorizontalAlignment="Center">
                        <TextBlock Text="{Binding ChiffreAffaires, StringFormat={}{0:N2} DA}" 
                                   FontSize="22" FontWeight="Bold" Foreground="#16A34A" HorizontalAlignment="Center"/>
                        <TextBlock Text="Chiffre d'affaires" Foreground="#64748B" FontSize="12" HorizontalAlignment="Center"/>
                    </StackPanel>
                </Border>
                <Border Grid.Column="1" Background="#FEF2F2" CornerRadius="10" Padding="20,15" Margin="5,0">
                    <StackPanel HorizontalAlignment="Center">
                        <TextBlock Text="{Binding Depenses, StringFormat={}{0:N2} DA}" 
                                   FontSize="22" FontWeight="Bold" Foreground="#DC2626" HorizontalAlignment="Center"/>
                        <TextBlock Text="DÃ©penses" Foreground="#64748B" FontSize="12" HorizontalAlignment="Center"/>
                    </StackPanel>
                </Border>
                <Border Grid.Column="2" Background="#EFF6FF" CornerRadius="10" Padding="20,15" Margin="10,0,0,0">
                    <StackPanel HorizontalAlignment="Center">
                        <TextBlock Text="{Binding BeneficeNet, StringFormat={}{0:N2} DA}" 
                                   FontSize="22" FontWeight="Bold" Foreground="#2563EB" HorizontalAlignment="Center"/>
                        <TextBlock Text="BÃ©nÃ©fice net" Foreground="#64748B" FontSize="12" HorizontalAlignment="Center"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- Journal -->
        <Grid Grid.Row="3" RowDefinitions="Auto,*">
            <!-- Journal filters -->
            <Border Grid.Row="0" Background="White" Padding="30,12" BorderBrush="#E2E8F0" BorderThickness="0,0,0,1">
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <!-- Type filter buttons -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="0">
                        <Button Content="Tous" Padding="14,8" CornerRadius="6,0,0,6"
                                Tag="0" Click="OnTypeFiltreClick"/>
                        <Button Content="Recettes" Padding="14,8" CornerRadius="0"
                                Tag="1" Click="OnTypeFiltreClick"/>
                        <Button Content="DÃ©penses" Padding="14,8" CornerRadius="0,6,6,0"
                                Tag="2" Click="OnTypeFiltreClick"/>
                    </StackPanel>
                    
                    <!-- Category filter -->
                    <ComboBox Grid.Column="2" ItemsSource="{Binding CategoriesFiltre}" 
                              SelectedItem="{Binding CategorieFiltre}"
                              Width="200" Margin="10,0,0,0"/>
                </Grid>
            </Border>

            <!-- Transaction list -->
            <ScrollViewer Grid.Row="1" Padding="30,15">
                <StackPanel Spacing="6">
                    <!-- Error message -->
                    <Border Background="#FEE2E2" CornerRadius="8" Padding="15"
                            IsVisible="{Binding ErreurMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                        <TextBlock Text="{Binding ErreurMessage}" Foreground="#DC2626" TextWrapping="Wrap"/>
                    </Border>

                    <!-- Empty state -->
                    <Border Background="#F8FAFC" CornerRadius="12" Padding="40"
                            IsVisible="{Binding !Transactions.Count}"
                            HorizontalAlignment="Center">
                        <StackPanel HorizontalAlignment="Center" Spacing="10">
                            <TextBlock Text="ðŸ“Š" FontSize="40" HorizontalAlignment="Center"/>
                            <TextBlock Text="Aucune transaction" FontSize="18" FontWeight="SemiBold" 
                                       Foreground="#64748B" HorizontalAlignment="Center"/>
                            <TextBlock Text="Ajoutez votre premiÃ¨re transaction"
                                       Foreground="#94A3B8" HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <!-- Table header -->
                    <Grid ColumnDefinitions="100,100,120,*,140,80" Background="#F1F5F9" Margin="0,0,0,4">
                        <TextBlock Grid.Column="0" Text="Date" FontWeight="SemiBold" Foreground="#64748B" Padding="12,10" FontSize="12"/>
                        <TextBlock Grid.Column="1" Text="Type" FontWeight="SemiBold" Foreground="#64748B" Padding="8,10" FontSize="12"/>
                        <TextBlock Grid.Column="2" Text="CatÃ©gorie" FontWeight="SemiBold" Foreground="#64748B" Padding="8,10" FontSize="12"/>
                        <TextBlock Grid.Column="3" Text="Commentaire" FontWeight="SemiBold" Foreground="#64748B" Padding="8,10" FontSize="12"/>
                        <TextBlock Grid.Column="4" Text="Montant" FontWeight="SemiBold" Foreground="#64748B" Padding="8,10" FontSize="12" HorizontalAlignment="Right"/>
                        <TextBlock Grid.Column="5" Text="Actions" FontWeight="SemiBold" Foreground="#64748B" Padding="8,10" FontSize="12" HorizontalAlignment="Center"/>
                    </Grid>

                    <!-- Transaction rows -->
                    <ItemsControl ItemsSource="{Binding Transactions}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="models:Transaction">
                                <Border Classes="transaction-row" Background="White" Padding="0" Margin="0,0,0,2"
                                        BorderBrush="#E2E8F0" BorderThickness="0,0,0,1">
                                    <Grid ColumnDefinitions="100,100,120,*,140,80">
                                        <!-- Date -->
                                        <TextBlock Grid.Column="0" Text="{Binding Date, StringFormat={}{0:dd/MM/yyyy}}" 
                                                   VerticalAlignment="Center" Padding="12,10" Foreground="#1E293B" FontSize="13"/>

                                        <!-- Type -->
                                        <Border Grid.Column="1" VerticalAlignment="Center" Margin="8,0" HorizontalAlignment="Left"
                                                Background="{Binding Type, Converter={x:Static conv:TransactionTypeToBackgroundConverter.Instance}}"
                                                CornerRadius="4" Padding="8,3">
                                            <TextBlock Text="{Binding Type, Converter={x:Static conv:TransactionTypeToLabelConverter.Instance}}" 
                                                       FontSize="12" FontWeight="SemiBold"
                                                       Foreground="{Binding Type, Converter={x:Static conv:TransactionTypeToColorConverter.Instance}}"/>
                                        </Border>

                                        <!-- Category -->
                                        <TextBlock Grid.Column="2" Text="{Binding Categorie}" 
                                                   VerticalAlignment="Center" Padding="8,10" Foreground="#64748B" FontSize="13"/>

                                        <!-- Commentary (Description) -->
                                        <StackPanel Grid.Column="3" VerticalAlignment="Center" Orientation="Horizontal" Spacing="6" Margin="8,0">
                                            <TextBlock Text="{Binding Description}" Foreground="#1E293B" FontSize="13" TextTrimming="CharacterEllipsis"/>
                                            <Border Background="#F1F5F9" CornerRadius="4" Padding="6,2"
                                                    IsVisible="{Binding NumeroFacture, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                                <TextBlock Text="{Binding NumeroFacture}" FontSize="10" Foreground="#64748B"/>
                                            </Border>
                                        </StackPanel>

                                        <!-- Amount -->
                                        <StackPanel Grid.Column="4" Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,8,0">
                                            <TextBlock Text="{Binding Type, Converter={x:Static conv:TransactionTypeToSignConverter.Instance}}"
                                                       FontWeight="Bold" FontSize="14"
                                                       Foreground="{Binding Type, Converter={x:Static conv:TransactionTypeToColorConverter.Instance}}"/>
                                            <TextBlock Text="{Binding Montant, StringFormat={}{0:N2} DA}"
                                                       FontWeight="Bold" FontSize="14"
                                                       Foreground="{Binding Type, Converter={x:Static conv:TransactionTypeToColorConverter.Instance}}"/>
                                        </StackPanel>

                                        <!-- Action buttons (visible on hover) -->
                                        <StackPanel Classes="action-buttons" Grid.Column="5" Orientation="Horizontal" Spacing="4" 
                                                    VerticalAlignment="Center" HorizontalAlignment="Center">
                                            <Button Content="âœï¸" Padding="6,4" Background="Transparent"
                                                    FontSize="14" Cursor="Hand"
                                                    Click="OnEditTransactionClick"/>
                                            <Button Content="ðŸ“¦" Padding="6,4" Background="Transparent"
                                                    FontSize="14" Cursor="Hand"
                                                    Click="OnArchiveTransactionClick"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </ScrollViewer>
        </Grid>
        
        <!-- Transaction Form Overlay -->
        <Border Grid.RowSpan="4" Background="#80000000" IsVisible="{Binding AfficherFormulaire}">
            <Border Background="White" CornerRadius="12" Padding="30" 
                    MaxWidth="500" HorizontalAlignment="Center" VerticalAlignment="Center">
                <StackPanel Spacing="15">
                    <TextBlock Text="{Binding TitreFormulaire}" FontSize="20" FontWeight="Bold" Foreground="#1E293B"/>
                    
                    <StackPanel Spacing="5">
                        <TextBlock Text="Type" Foreground="#64748B" FontSize="12"/>
                        <ComboBox SelectedIndex="{Binding FormTypeIndex}" HorizontalAlignment="Stretch">
                            <ComboBoxItem Content="Recette"/>
                            <ComboBoxItem Content="DÃ©pense"/>
                        </ComboBox>
                    </StackPanel>

                    <StackPanel Spacing="5">
                        <TextBlock Text="Date" Foreground="#64748B" FontSize="12"/>
                        <DatePicker SelectedDate="{Binding FormDate}" HorizontalAlignment="Stretch"/>
                    </StackPanel>

                    <StackPanel Spacing="5">
                        <TextBlock Text="Description" Foreground="#64748B" FontSize="12"/>
                        <TextBox Text="{Binding FormDescription}" Watermark="Description de la transaction"/>
                    </StackPanel>

                    <StackPanel Spacing="5">
                        <TextBlock Text="Montant (DA)" Foreground="#64748B" FontSize="12"/>
                        <TextBox Text="{Binding FormMontant}" Watermark="0.00"/>
                    </StackPanel>

                    <StackPanel Spacing="5">
                        <TextBlock Text="CatÃ©gorie" Foreground="#64748B" FontSize="12"/>
                        <ComboBox ItemsSource="{Binding CategoriesNoms}" 
                                  SelectedItem="{Binding FormCategorie}"
                                  HorizontalAlignment="Stretch"
                                  PlaceholderText="Choisir une catÃ©gorie"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Spacing="15" HorizontalAlignment="Right" Margin="0,10,0,0">
                        <Button Content="Annuler" 
                                Command="{Binding AnnulerFormulaireCommand}"
                                Padding="20,10"
                                Background="#E2E8F0"/>
                        <Button Content="Enregistrer" 
                                Command="{Binding EnregistrerTransactionCommand}"
                                Padding="20,10"
                                Background="#2563EB"
                                Foreground="White"
                                FontWeight="SemiBold"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Border>

        <!-- Category Form Overlay -->
        <Border Grid.RowSpan="4" Background="#80000000" IsVisible="{Binding AfficherFormulaireCategorie}">
            <Border Background="White" CornerRadius="12" Padding="30" 
                    MaxWidth="400" HorizontalAlignment="Center" VerticalAlignment="Center">
                <StackPanel Spacing="15">
                    <TextBlock Text="Nouvelle catÃ©gorie" FontSize="20" FontWeight="Bold" Foreground="#1E293B"/>
                    
                    <StackPanel Spacing="5">
                        <TextBlock Text="Nom" Foreground="#64748B" FontSize="12"/>
                        <TextBox Text="{Binding NouvelleCategorieNom}" Watermark="Nom de la catÃ©gorie"/>
                    </StackPanel>

                    <StackPanel Spacing="5">
                        <TextBlock Text="Type" Foreground="#64748B" FontSize="12"/>
                        <ComboBox SelectedIndex="{Binding NouvelleCategorieTypeIndex}" HorizontalAlignment="Stretch">
                            <ComboBoxItem Content="Recette"/>
                            <ComboBoxItem Content="DÃ©pense"/>
                        </ComboBox>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Spacing="15" HorizontalAlignment="Right" Margin="0,10,0,0">
                        <Button Content="Annuler" 
                                Command="{Binding AnnulerCategorieCommand}"
                                Padding="20,10"
                                Background="#E2E8F0"/>
                        <Button Content="Enregistrer" 
                                Command="{Binding EnregistrerCategorieCommand}"
                                Padding="20,10"
                                Background="#2563EB"
                                Foreground="White"
                                FontWeight="SemiBold"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Border>

    </Grid>
</UserControl>
